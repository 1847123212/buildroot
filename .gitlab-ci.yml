# Configuration for Gitlab-CI.
# Builds appear on https://gitlab.com/buildroot.org/buildroot/pipelines
# The .gitlab-ci.yml file is generated from .gitlab-ci.yml.in.
# It needs to be regenerated every time a defconfig is added, using
# "make .gitlab-ci.yml".

image: maohan001/ubuntu-buildroot

stages:
  - 610-chip-build
  - 610-chip-test
  - 807-chip-build
  - 807-chip-test
  - 807-qemu-build
  - 807-qemu-test
  - 810-qemu-build
  - 810-qemu-test
  - sales-build
  - toolchain-multi-libs

variables:
    PREFIX: ""
    SUFFIX: ""
    610_CHIP_PREFIX: csky_610_
    807_CHIP_PREFIX: csky_610_
    CHIP_SUFFIX: _br_defconfig
    807_QEMU_PREFIX: qemu_csky_807_
    810_QEMU_PREFIX: qemu_csky_810_
    QEMU_SUFFIX: _br_defconfig
    SALES_PREFIX: csky_
    SALES_SUFFIX: _defconfig
    CONFIG_NAME: ""

.build_buildroot: &build_buildroot
    - echo 'Configure Buildroot'
    - CONFIG_NAME=${PREFIX}${CI_BUILD_NAME}${SUFFIX}
    - echo ${CONFIG_NAME}
    - make ${CONFIG_NAME}
    - echo 'Build buildroot'
    - |
        make > >(tee build.log |grep '>>>') 2>&1 || {
            echo 'Failed build last output'
            tail -200 build.log
            xz -z build.log
            exit 1
        }
    - xz -z build.log
    - if [ -f output/images/vmlinux ]; then
          output/host/bin/csky-linux-strip -sg output/images/vmlinux;
          xz -z output/images/vmlinux;
      fi
    - if [ -f output/images/rootfs.cpio ]; then
          rm -f output/images/rootfs.tar;
          xz -z output/images/rootfs.cpio;
      fi
    - if [ -f output/images/rootfs.tar ]; then
          xz -z output/images/rootfs.tar;
      fi

.common_builds: &common_builds
    script: *build_buildroot
    dependencies: []
    cache:
      paths:
        - dl/
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - output/images/
            - build.log.xz

.common_tests: &common_tests
    - echo 'Prepare to run'
    - mkdir -p output/host/
    - tar -xf output/images/csky_toolchain_*.tar.xz -C output/host
    - if [ -f output/images/vmlinux.xz ]; then
          xz -d output/images/vmlinux.xz;
      fi
    - if [ -f output/images/rootfs.tar.xz ]; then
          xz -d output/images/rootfs.tar.xz;
      fi
    - if [ -f output/images/rootfs.cpio.xz ]; then
          xz -d output/images/rootfs.cpio.xz;
      fi
    - ./output/host/csky-ci/run_test.sh
    - ./output/host/csky-ci/generic_analyze.sh || exit 1

################ chip ################
.610_chip_build_before: &610_chip_build_before
    - PREFIX=${610_CHIP_PREFIX}
    - SUFFIX=${CHIP_SUFFIX}

.610_chip_build: &610_chip_build
    stage: 610-chip-build
    before_script: *610_chip_build_before
    <<: *common_builds

.610_chip_test: &610_chip_test
    stage: 610-chip-test
    script: *common_tests
    artifacts:
        when: on_success
        paths:
            - test.log

.807_chip_build_before: &807_chip_build_before
    - PREFIX=${807_CHIP_PREFIX}
    - SUFFIX=${CHIP_SUFFIX}

.807_chip_build: &807_chip_build
    stage: 807-chip-build
    before_script: *807_chip_build_before
    <<: *common_builds

.807_chip_test: &807_chip_test
    stage: 807-chip-test
    script: *common_tests
    artifacts:
        when: on_success
        paths:
            - test.log

# chip-build
# 610
gx6622_4.9_uclibc: *610_chip_build
gx6622_4.9_glibc: *610_chip_build
gx6622_4.14_uclibc: *610_chip_build
gx6622_4.14_glibc: *610_chip_build
gx6622_4.16_glibc: *610_chip_build

# 807
eragon_4.9_uclibc: *807_chip_build
eragon_4.9_glibc: *807_chip_build
eragon_4.14_uclibc: *807_chip_build
eragon_4.14_glibc: *807_chip_build
f_eragon_4.9_glibc: *807_chip_build

# chip-test
# 610
gx6622_4.9_uclibc_test:
    tags:
      - csky-610-gx6622
    dependencies:
      - gx6622_4.9_uclibc
    <<: *610_chip_test

gx6622_4.9_glibc_test:
    tags:
      - csky-610-gx6622
    dependencies:
      - gx6622_4.9_glibc
    <<: *610_chip_test

gx6622_4.14_uclibc_test:
    tags:
      - csky-610-gx6622
    dependencies:
      - gx6622_4.14_uclibc
    <<: *610_chip_test

gx6622_4.14_glibc_test:
    tags:
      - csky-610-gx6622
    dependencies:
      - gx6622_4.14_glibc
    <<: *610_chip_test

gx6622_4.16_glibc_test:
    tags:
      - csky-610-gx6622
    dependencies:
      - gx6622_4.16_glibc
    <<: *610_chip_test

# 807
eragon_4.9_uclibc_test:
    tags:
      - csky-807-eragon
    dependencies:
      - eragon_4.9_uclibc
    <<: *807_chip_test

eragon_4.9_glibc_test:
    tags:
      - csky-807-eragon
    dependencies:
      - eragon_4.9_glibc
    <<: *807_chip_test

eragon_4.14_uclibc_test:
    tags:
      - csky-807-eragon
    dependencies:
      - eragon_4.14_uclibc
    <<: *807_chip_test

eragon_4.14_glibc_test:
    tags:
      - csky-807-eragon
    dependencies:
      - eragon_4.14_glibc
    <<: *807_chip_test

f_eragon_4.9_glibc_test:
    tags:
      - csky-807-eragon
    dependencies:
      - f_eragon_4.9_glibc
    <<: *807_chip_test

################ qemu ################
.807_qemu_build_before: &807_qemu_build_before
    - PREFIX=${807_QEMU_PREFIX}
    - SUFFIX=${QEMU_SUFFIX}

.807_qemu_build: &807_qemu_build
    stage: 807-qemu-build
    before_script: *807_qemu_build_before
    <<: *common_builds

.807_qemu_test: &807_qemu_test
    stage: 807-qemu-test
    script: *common_tests
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log

.810_qemu_build_before: &810_qemu_build_before
    - PREFIX=${810_QEMU_PREFIX}
    - SUFFIX=${QEMU_SUFFIX}

.810_qemu_build: &810_qemu_build
    stage: 810-qemu-build
    before_script: *810_qemu_build_before
    <<: *common_builds

.810_qemu_test: &810_qemu_test
    stage: 810-qemu-test
    script: *common_tests
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log

# qemu-build
# 807
f_4.9_uclibc: *807_qemu_build
f_4.9_glibc: *807_qemu_build
f_4.14_uclibc: *807_qemu_build
f_4.14_glibc: *807_qemu_build

# 810
f_4.9_uclibc: *810_qemu_build
f_4.9_glibc: *810_qemu_build
f_4.14_uclibc: *810_qemu_build
f_4.14_glibc: *810_qemu_build

# qemu-test
# 807
f_4.9_uclibc_test:
    dependencies:
      - f_4.9_uclibc
    <<: *807_qemu_test

f_4.9_glibc_test:
    dependencies:
      - f_4.9_glibc
    <<: *807_qemu_test

f_4.14_uclibc_test:
    dependencies:
      - f_4.14_uclibc
    <<: *807_qemu_test

f_4.14_glibc_test:
    dependencies:
      - f_4.14_glibc
    <<: *807_qemu_test

# 810
f_4.9_uclibc_test:
    dependencies:
      - f_4.9_uclibc
    <<: *810_qemu_test

f_4.9_glibc_test:
    dependencies:
      - f_4.9_glibc
    <<: *810_qemu_test

f_4.14_uclibc_test:
    dependencies:
      - f_4.14_uclibc
    <<: *810_qemu_test

f_4.14_glibc_test:
    dependencies:
      - f_4.14_glibc
    <<: *810_qemu_test

################ sales ################
.sales_build_before: &sales_build_before
    - PREFIX=${SALES_PREFIX}
    - SUFFIX=${SALES_SUFFIX}

.sales_build: &sales_build
    stage: sales-build
    before_script: *sales_build_before
    <<: *common_builds

# sales-build
860_platform: *sales_build
gx6605s_fbcon: *sales_build
gx6605s: *sales_build

# sales-test
# sales has no test

################ toolchain ################
# toolchain-multi-libs
abiv2-uclibc:
    stage: toolchain-multi-libs
    dependencies: []
    script:
      - echo abiv2-uclibc

abiv2-glibc:
    stage: toolchain-multi-libs
    dependencies: []
    script:
      - echo abiv2-glibc
