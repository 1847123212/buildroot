# Configuration for Gitlab-CI.
# Builds appear on https://gitlab.com/buildroot.org/buildroot/pipelines
# The .gitlab-ci.yml file is generated from .gitlab-ci.yml.in.
# It needs to be regenerated every time a defconfig is added, using
# "make .gitlab-ci.yml".

image: maohan001/ubuntu-buildroot

stages:
  - chip-build
  - chip-test
  - qemu-build
  - qemu-test
  - toolchain-multi-libs

.build_buildroot: &build_buildroot
    - echo 'Configure Buildroot'
    - make ${CI_BUILD_NAME}
    - echo 'Build buildroot'
    - |
        make > >(tee build.log |grep '>>>') 2>&1 || {
            echo 'Failed build last output'
            tail -200 build.log
            xz -z build.log
            exit 1
        }
    - xz -z build.log
    - if [ -f output/images/vmlinux ]; then
          output/host/bin/csky-linux-strip -sg output/images/vmlinux;
          xz -z output/images/vmlinux;
      fi
    - if [ -f output/images/rootfs.cpio ]; then
          rm -f output/images/rootfs.tar;
          xz -z output/images/rootfs.cpio;
      fi
    - if [ -f output/images/rootfs.tar ]; then
          xz -z output/images/rootfs.tar;
      fi

.qemu_test: &qemu_test
    - echo 'Prepare to run'
    - mkdir -p output/host/
    - tar -xf output/images/csky_toolchain_*.tar.xz -C output/host
    - if [ -f output/images/vmlinux.xz ]; then
          xz -d output/images/vmlinux.xz;
      fi
    - if [ -f output/images/rootfs.tar.xz ]; then
          xz -d output/images/rootfs.tar.xz;
      fi
    - if [ -f output/images/rootfs.cpio.xz ]; then
          xz -d output/images/rootfs.cpio.xz;
      fi
    - echo 'Run qemu test'
    - |
        ./output/host/csky-ci/run_test.sh || {
            exit 1
        }

.chip_test: &chip_test
    - echo 'Prepare to run'
    - mkdir -p output/host/
    - tar -xf output/images/csky_toolchain_*.tar.xz -C output/host
    - if [ -f output/images/vmlinux.xz ]; then
          xz -d output/images/vmlinux.xz;
      fi
    - if [ -f output/images/rootfs.tar.xz ]; then
          xz -d output/images/rootfs.tar.xz;
      fi
    - if [ -f output/images/rootfs.cpio.xz ]; then
          xz -d output/images/rootfs.cpio.xz;
      fi
    - echo 'Run local test'
    - csky_switch /dev/ttyUSB1 off
    - csky_switch /dev/ttyUSB1 on
    - touch /root/DebugServerConsole/.stamp_gdb
    - sleep 25
    - |
        ./output/host/csky-ci/run_test.sh || {
            touch /root/DebugServerConsole/.stamp_gdb_exit
            csky_switch /dev/ttyUSB1 off
            exit 1
        }
    - touch /root/DebugServerConsole/.stamp_gdb_exit
    - csky_switch /dev/ttyUSB1 off

.defconfig: &defconfig
    script: *build_buildroot
    dependencies: []
    stage: qemu-build
    cache:
      paths:
        - dl/
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - output/images/
            - build.log.xz
            - build.log

.chip-defconfig: &chip-defconfig
    script: *build_buildroot
    dependencies: []
    stage: chip-build
    cache:
      paths:
        - dl/
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - output/images/
            - build.log.xz
            - build.log

# qemu ck810f
qemu_csky_ck810f_4.16_uclibc_defconfig: *defconfig
qemu_csky_ck810f_4.16_uclibc_defconfig_test:
    stage: qemu-test
    script: *qemu_test
    dependencies:
      - qemu_csky_ck810f_4.16_uclibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck810f_4.16_glibc_defconfig: *defconfig
qemu_csky_ck810f_4.16_glibc_defconfig_test:
    stage: qemu-test
    script: *qemu_test
    dependencies:
      - qemu_csky_ck810f_4.16_glibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck810f_4.9_uclibc_defconfig: *defconfig
qemu_csky_ck810f_4.9_uclibc_defconfig_test:
    stage: qemu-test
    script: *qemu_test
    dependencies:
      - qemu_csky_ck810f_4.9_uclibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck810f_4.9_glibc_defconfig: *defconfig
qemu_csky_ck810f_4.9_glibc_defconfig_test:
    stage: qemu-test
    script: *qemu_test
    dependencies:
      - qemu_csky_ck810f_4.9_glibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

# qemu ck807f
qemu_csky_ck807f_4.18_uclibc_defconfig: *defconfig
qemu_csky_ck807f_4.18_uclibc_defconfig_test:
    stage: qemu-test
    script: *qemu_test
    dependencies:
      - qemu_csky_ck807f_4.18_uclibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck807f_4.18_glibc_defconfig: *defconfig
qemu_csky_ck807f_4.18_glibc_defconfig_test:
    stage: qemu-test
    script: *qemu_test
    dependencies:
      - qemu_csky_ck807f_4.18_glibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck807f_4.16_uclibc_defconfig: *defconfig
qemu_csky_ck807f_4.16_uclibc_defconfig_test:
    stage: qemu-test
    script: *qemu_test
    dependencies:
      - qemu_csky_ck807f_4.16_uclibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck807f_4.16_glibc_defconfig: *defconfig
qemu_csky_ck807f_4.16_glibc_defconfig_test:
    stage: qemu-test
    script: *qemu_test
    dependencies:
      - qemu_csky_ck807f_4.16_glibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck807f_4.14_uclibc_defconfig: *defconfig
qemu_csky_ck807f_4.14_uclibc_defconfig_test:
    stage: qemu-test
    script: *qemu_test
    dependencies:
      - qemu_csky_ck807f_4.14_uclibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck807f_4.14_glibc_defconfig: *defconfig
qemu_csky_ck807f_4.14_glibc_defconfig_test:
    stage: qemu-test
    script: *qemu_test
    dependencies:
      - qemu_csky_ck807f_4.14_glibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck807f_4.9_uclibc_defconfig: *defconfig
qemu_csky_ck807f_4.9_uclibc_defconfig_test:
    stage: qemu-test
    script: *qemu_test
    dependencies:
      - qemu_csky_ck807f_4.9_uclibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck807f_4.9_glibc_defconfig: *defconfig
qemu_csky_ck807f_4.9_glibc_defconfig_test:
    stage: qemu-test
    script: *qemu_test
    dependencies:
      - qemu_csky_ck807f_4.9_glibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

# chip
csky_ck860_platform_defconfig: *chip-defconfig
csky_gx6605s_fbcon_defconfig: *chip-defconfig
csky_gx6605s_defconfig: *chip-defconfig

csky_ck610_gx6622_4.9_uclibc_bt_defconfig: *chip-defconfig
csky_ck610_gx6622_4.9_uclibc_bt_defconfig_test:
    stage: chip-test
    tags:
      - vmh-ck610-gx-0
    script: *chip_test
    dependencies:
      - csky_ck610_gx6622_4.9_uclibc_bt_defconfig
    artifacts:
        when: on_success
        paths:
            - test.log
            - test_sum.log

csky_ck610_gx6622_4.16_glibc_bt_defconfig: *chip-defconfig
csky_ck610_gx6622_4.16_glibc_bt_defconfig_test:
    stage: chip-test
    tags:
      - vmh-ck610-gx-0
    script: *chip_test
    dependencies:
      - csky_ck610_gx6622_4.16_glibc_bt_defconfig
    artifacts:
        when: on_success
        paths:
            - test.log
            - test_sum.log

csky_ck807_eragon_4.9_glibc_bt_defconfig: *chip-defconfig
csky_ck807_eragon_4.9_glibc_bt_defconfig_test:
    stage: chip-test
    tags:
      - vmh-ck807-eragon-0
    script: *chip_test
    dependencies:
      - csky_ck807_eragon_4.9_glibc_bt_defconfig
    artifacts:
        when: on_success
        paths:
            - test.log
            - test_sum.log

# toolchain-multi-libs
abiv2-uclibc:
    stage: toolchain-multi-libs
    dependencies: []
    script:
      - echo abiv2-uclibc

abiv2-glibc:
    stage: toolchain-multi-libs
    dependencies: []
    script:
      - echo abiv2-glibc
