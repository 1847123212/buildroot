# Configuration for Gitlab-CI.
# Builds appear on https://gitlab.com/buildroot.org/buildroot/pipelines
# The .gitlab-ci.yml file is generated from .gitlab-ci.yml.in.
# It needs to be regenerated every time a defconfig is added, using
# "make .gitlab-ci.yml".

image: buildroot/base

stages:
  - build
  - test
  - deploy

.build_buildroot: &build_buildroot
    - echo 'Configure Buildroot'
    - make ${CI_BUILD_NAME}
    - echo 'Build buildroot'
    - |
        make > >(tee build.log |grep '>>>') 2>&1 || {
            echo 'Failed build last output'
            tail -200 build.log
            exit 1
        }

.run_test: &run_test
    - echo 'Run test'
    - |
        ./output/host/csky-ci/run_test.sh || {
            echo 'Failed build last output'
            tail -200 test.log
            exit 1
        }
    - cat test_sum.log

.run_test_board: &run_test_board
    - echo 'Run test'
    - ./output/host/csky-ci/gen_rtb.sh
    - |
        ./output/host/csky-ci/run_test.sh || {
            echo 'Failed build last output'
            tail -200 test.log
            exit 1
        }
    - cat test_sum.log

.defconfig: &defconfig
    stage: build
    script: *build_buildroot
    cache:
      paths:
        - dl/
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - output/build/build-time.log
            - output/host/
            - output/images/
            - output/build/packages-file-list.txt
            - build.log
            - test.log
            - test_sum.log
            
.sc8925_defconfig: &sc8925_defconfig
    stage: build
    script: *build_buildroot
#    tags:
#      - vmh-sc8925
    cache:
      paths:
        - dl/
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - output/build/build-time.log
            - output/host/
            - output/images/
            - output/build/packages-file-list.txt
            - build.log

.gx6622_defconfig: &gx6622_defconfig
    stage: build
    script: *build_buildroot
    tags:
      - vmh-sc8925
    cache:
      paths:
        - dl/
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - output/build/build-time.log
            - output/host/
            - output/images/
            - output/build/packages-file-list.txt
            - build.log

csky_gx6605s_defconfig: *defconfig
csky_gx6605s_fbcon_defconfig: *defconfig
csky_sc6138a_defconfig: *defconfig
csky_eragon_defconfig: *defconfig
qemu_csky_ck810_glibc_bt_defconfig: *defconfig
qemu_csky_ck810_uclibc_bt_defconfig: *defconfig
qemu_csky_ck807_glibc_bt_defconfig: *defconfig
qemu_csky_ck807_uclibc_bt_defconfig: *defconfig
qemu_csky_ck610_uclibc_bt_defconfig: *defconfig
qemu_csky_ck610_glibc_bt_defconfig: *defconfig
csky_sc8925_bt_defconfig: *sc8925_defconfig
csky_gx6622_bt_defconfig: *gx6622_defconfig

qemu_csky_ck810_glibc_bt_defconfig_test:
    stage: test
    script: *run_test
    dependencies:
      - qemu_csky_ck810_glibc_bt_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck810_uclibc_bt_defconfig_test:
    stage: test
    script: *run_test
    dependencies:
      - qemu_csky_ck810_uclibc_bt_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck807_glibc_bt_defconfig_test:
    stage: test
    script: *run_test
    dependencies:
      - qemu_csky_ck807_glibc_bt_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck807_uclibc_bt_defconfig_test:
    stage: test
    script: *run_test
    dependencies:
      - qemu_csky_ck807_uclibc_bt_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck610_glibc_bt_defconfig_test:
    stage: test
    script: *run_test
    dependencies:
      - qemu_csky_ck610_glibc_bt_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck610_uclibc_bt_defconfig_test:
    stage: test
    script: *run_test
    dependencies:
      - qemu_csky_ck610_uclibc_bt_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

#csky_sc8925_bt_defconfig_test:
#    stage: test
#    tags:
#      - vmh-sc8925
#    script: *run_test_board
#    dependencies:
#      - csky_sc8925_bt_defconfig
#    artifacts:
#        when: always
#        expire_in: 2 weeks
#        paths:
#            - test.log
#            - test_sum.log

csky_gx6622_bt_defconfig_test:
    stage: test
    tags:
      - vmh-sc8925
    script: *run_test_board
    dependencies:
      - csky_gx6622_bt_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

deploy_to_github:
    stage: deploy
    script:
      - echo deploy
